apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: kustomize-apps
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ['missingkey=error']
  generators:
    - matrix:
        generators:
          - list:
              elements:
                - env: dev
          - list:
              elements:
                - name: argocd
                  path: kubernetes/applications/argocd
                  namespace: argocd
                - name: external-secrets
                  path: kubernetes/applications/external-secrets
                  namespace: external-secrets-system
                  overlay: base
                - name: traefik
                  path: kubernetes/applications/traefik
                  namespace: traefik
                - name: cert-manager
                  path: kubernetes/applications/cert-manager
                  namespace: cert-manager
                - name: trivy-operator
                  namespace: trivy-system
                  path: kubernetes/applications/trivy-operator
                  overlay: base
                - name: nginx 
                  path: kubernetes/applications/nginx
                  namespace: nginx
                # - name: rancher
                #   path: kubernetes/applications/rancher
                #   namespace: cattle-system
                - name: monitoring
                  path: kubernetes/applications/monitoring
                  namespace: monitoring
                - name: homepage
                  path: kubernetes/applications/homepage
                  namespace: homepage 
  template:
    metadata:
      name: '{{.name}}'
      labels:
        environment: '{{ .env }}'
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: default
      source:
        repoURL: https://github.com/esoto6/homelab.git
        targetRevision: HEAD
        path: '{{.path}}{{if .overlay}}/{{.overlay}}{{else}}/overlays/{{.env}}{{end}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ .namespace }}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ApplyOutOfSyncOnly=true
      ignoreDifferences:
        - group: "*"
          kind: "*"
          namespace: "argocd"
          jsonPointers:
            - /metadata/annotations/argocd.argoproj.io~1tracking-id